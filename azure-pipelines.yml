# Azure DevOps Pipeline for Build + Push + Deploy to AKS

trigger:
- Backend007

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: 'container123'
  imageRepository: 'test'
  containerRegistry: 'endregistry.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'test-auth'
  vmImageName: 'ubuntu-latest'
  azureSubscription: 'azure-container'   # ARM Connection Name
  aksResourceGroup: 'aks-rg'
  aksClusterName: 'aks-project'

stages:

##############################
# BUILD & PUSH STAGE
##############################
- stage: Build
  displayName: "Build and Push Stage"
  jobs:
  - job: Build
    displayName: "Build"
    pool:
      vmImage: $(vmImageName)
    steps:

    - task: Maven@4
      displayName: "Build Maven Project"
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean install -DskipTests=true'

    - task: Docker@2
      displayName: "Build Docker Image"
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

    - task: Docker@2
      displayName: "Push Docker Image to ACR"
      inputs:
        command: push
        repository: $(imageRepository)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

    - upload: manifests
      artifact: manifests


